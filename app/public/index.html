<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Example Client Solar Dashboard</title>
<link rel="stylesheet" href="assets/styles.css">
<script>window.API_BASE='/api';</script>
<script src="https://unpkg.com/vue@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div id="app" v-cloak>
  <header>
    <div>
      <img src="assets/client-logo.svg" class="logo" alt="Client logo"> Example Client
    </div>
    <div>
      Built by SUNQ <img src="assets/sunq-logo.svg" class="logo" alt="SUNQ logo">
      <button class="toggle" @click="toggleTheme">{{ theme==='dark' ? 'Light' : 'Dark' }}</button>
    </div>
  </header>
  <div class="container">
    <div v-if="error" class="card">{{ error }}</div>
    <div v-if="view==='stations'">
      <input type="text" v-model="search" placeholder="Search" aria-label="Search stations">
      <div v-if="filteredStations.length===0" class="card">Empty</div>
      <div v-for="s in filteredStations" :key="s.code" class="card" @click="selectStation(s)" role="button" tabindex="0">
        <strong>{{ s.name }}</strong><br>
        <small>{{ s.city }}</small>
      </div>
    </div>
      <div v-else>
      <button @click="view='stations'">&lt; Back</button>
      <h2>{{ station.name }}</h2>
      <div class="card">Current Power: {{ overview.currentPower ?? 'N/A' }}</div>
      <div class="card">Today Energy: {{ overview.todayEnergy ?? 'N/A' }}</div>
      <div class="card">Total Energy: {{ overview.totalEnergy ?? 'N/A' }}</div>
      <div v-if="overview.perpowerRatio" class="card">PR: {{ overview.perpowerRatio }}</div>
      <div class="card">
        <canvas id="powerChart" height="100"></canvas>
      </div>
      <h3>Devices</h3>
      <table class="table" v-if="devices.length">
        <thead><tr><th>ID</th><th>Type</th><th>Model</th><th>Status</th><th>Rated Power</th><th>SN</th></tr></thead>
        <tbody>
          <tr v-for="d in devices" :key="d.id">
            <td>{{ d.id }}</td>
            <td>{{ d.type }}</td>
            <td>{{ d.model }}</td>
            <td>{{ d.status }}</td>
            <td>{{ d.ratedPower ?? '-' }}</td>
            <td>{{ d.sn ?? '-' }}</td>
          </tr>
        </tbody>
      </table>
      <p v-else>Empty</p>
      <h3>Alarms</h3>
      <div>
        <button v-for="sev in severities" :key="sev" @click="alarmSeverity=sev;fetchAlarms();" :class="{active:alarmSeverity===sev}" class="toggle" style="margin-right:4px;">{{ sev }}</button>
      </div>
      <table class="table" v-if="filteredAlarms.length">
        <thead><tr><th>ID</th><th>Device</th><th>Level</th><th>Message</th><th>Start</th></tr></thead>
        <tbody>
          <tr v-for="a in filteredAlarms" :key="a.id+a.deviceId">
            <td>{{ a.id }}</td>
            <td>{{ a.deviceId }}</td>
            <td>{{ a.levelText || a.lev }}</td>
            <td>{{ a.message }}</td>
            <td>{{ a.startTime }}</td>
          </tr>
        </tbody>
      </table>
      <p v-else>Empty</p>
      <p>Last updated {{ lastUpdated }}</p>
    </div>
  </div>
</div>

<script>
const app = Vue.createApp({
  data() {
    return {
      stations: [],
      view: 'stations',
      station: null,
      overview: {},
      devices: [],
      alarms: [],
      alarmSeverity: 'all',
      severities: ['all','critical','major','minor','warning'],
      error: null,
      search: '',
      lastUpdated: null,
      theme: localStorage.getItem('theme') || 'light'
    }
  },
  computed: {
    levelsCsv() {
      const map = { critical: 1, major: 2, minor: 3, warning: 4, info: 4, all: null };
      const v = map[this.alarmSeverity];
      return v ? String(v) : '';
    },
    filteredStations() {
      const q = this.search.toLowerCase();
      return (this.stations || []).filter(s => (s.name || '').toLowerCase().includes(q));
    },
    filteredAlarms() {
      if (this.alarmSeverity === 'all') return this.alarms;
      return (this.alarms || []).filter(a => (a.levelText || '').toLowerCase() === this.alarmSeverity);
    }
  },
  mounted() {
    document.documentElement.setAttribute('data-theme', this.theme);
    this.fetchStations();
    setInterval(() => {
      if (this.view === 'detail' && this.station) {
        this.fetchOverview();
        this.fetchDevices();
        this.fetchAlarms();
        this.lastUpdated = new Date().toLocaleTimeString();
      }
    }, 60000);
  },
  methods: {
    toggleTheme() {
      this.theme = this.theme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', this.theme);
      localStorage.setItem('theme', this.theme);
    },
    fetchStations() {
      fetch(`${API_BASE}/stations`).then(r => r.json()).then(j => {
        if (j && j.ok) {
          this.stations = Array.isArray(j.data?.list) ? j.data.list : [];
        } else {
          this.error = 'Failed to load stations';
        }
      }).catch(() => this.error = 'Data service unavailable.');
    },
    selectStation(s) {
      this.station = s;
      this.view = 'detail';
      this.fetchOverview();
      this.fetchDevices();
      this.fetchAlarms();
      this.lastUpdated = new Date().toLocaleTimeString();
    },
    fetchOverview() {
      fetch(`${API_BASE}/stations/${this.station.code}/overview`)
        .then(r => r.json()).then(j => { if (j && j.ok) this.overview = j.data; });
    },
    fetchDevices() {
      fetch(`${API_BASE}/stations/${this.station.code}/devices`)
        .then(r => r.json()).then(j => { if (j && j.ok) this.devices = j.data; });
    },
    fetchAlarms() {
      fetch(`${API_BASE}/stations/${this.station.code}/alarms?levels=${this.levelsCsv}`)
        .then(r => r.json()).then(j => { if (j && j.ok) this.alarms = j.data; });
    },
    renderChart() {
      const ctx = document.getElementById('powerChart').getContext('2d');
      if (this.chart) this.chart.destroy();
      this.chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Power', data: [] }] }
      });
    }
  }
});

app.mount('#app');
</script>
</body>
</html>
